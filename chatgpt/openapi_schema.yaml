openapi: 3.1.0
info:
  title: BlitzGremlin Yahoo Fantasy API
  description: Custom API wrapper around Yahoo Fantasy Sports for BlitzGremlin GPT
  version: "1.0.0"
servers:
  - url: https://blitzgremlin.onrender.com

paths:
  /:
    get:
      summary: Health check
      operationId: health
      responses:
        "200":
          description: Service is running

  /login:
    get:
      summary: Start Yahoo OAuth login
      operationId: login
      responses:
        "302":
          description: Redirect to Yahoo login

  /callback:
    get:
      summary: Yahoo OAuth callback
      operationId: callback
      responses:
        "200":
          description: OAuth callback handled

  /profile:
    get:
      summary: Get Yahoo user profile
      operationId: getProfile
      responses:
        "200":
          description: Returns the authenticated user profile

  /my-leagues:
    get:
      summary: Get leagues for authenticated user
      operationId: getMyLeagues
      responses:
        "200":
          description: Returns all leagues for the authenticated user

  /my-team:
    get:
      summary: Get authenticated user's team
      operationId: getMyTeam
      responses:
        "200":
          description: Returns the authenticated user's fantasy team

  /league/{league_id}:
    get:
      summary: Get league details
      operationId: getLeague
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
          description: Numeric ID or full Yahoo league key (e.g., 461.l.1157326)
      responses:
        "200":
          description: Returns league details

  /matchups/{league_id}/{week}:
    get:
      summary: Get matchups for a given week
      operationId: getMatchups
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
        - in: path
          name: week
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Returns weekly matchups

  /matchups:
    get:
      summary: Get matchups with query params (supports ?week=current)
      operationId: getMatchupsQuery
      parameters:
        - in: query
          name: league_id
          required: true
          schema:
            type: string
          description: Yahoo league ID
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Week number or "current" for current week
      responses:
        "200":
          description: Returns matchups for specified week
        "400":
          description: Missing league_id parameter

  /standings/{league_id}:
    get:
      summary: Get league standings with points for/against
      operationId: getStandings
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Returns league standings with extracted points for/against per team
          content:
            application/json:
              schema:
                type: object
                properties:
                  league_id:
                    type: string
                  standings:
                    type: array
                    items:
                      type: object
                      properties:
                        team_key:
                          type: string
                        team_id:
                          type: string
                        name:
                          type: string
                        rank:
                          type: integer
                        wins:
                          type: integer
                        losses:
                          type: integer
                        ties:
                          type: integer
                        points_for:
                          type: number
                        points_against:
                          type: number
                        point_differential:
                          type: number
                  raw:
                    type: object

  /transactions/{league_id}:
    get:
      summary: Get league transactions (trades, adds, drops)
      operationId: getTransactions
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Returns recent league transactions (trades, adds, drops)

  /league/{league_id}/draftresults:
    get:
      summary: Get all draft picks for the league
      operationId: getDraftResults
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Returns all draft picks

  /league/{league_id}/players/stats:
    get:
      summary: Get full league player stats leaderboard
      operationId: getLeaguePlayersStats
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Optional week number for week-specific stats
      responses:
        "200":
          description: Returns full league player stats (season or week totals)

  /team/{team_key}/stats:
    get:
      summary: Get aggregated stats for a team's roster
      operationId: getTeamStats
      parameters:
        - in: path
          name: team_key
          required: true
          schema:
            type: string
          description: Yahoo team key (e.g., 461.l.1157326.t.1)
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Optional week number for week-specific stats
      responses:
        "200":
          description: Returns aggregated team stats by position and totals
          content:
            application/json:
              schema:
                type: object
                properties:
                  team_key:
                    type: string
                  league_id:
                    type: string
                  week:
                    type: string
                    nullable: true
                  team_name:
                    type: string
                  total_players:
                    type: integer
                  stats_by_position:
                    type: object
                    additionalProperties:
                      type: array
                      items:
                        type: object
                        properties:
                          stat_id:
                            type: string
                          stat_name:
                            type: string
                          value:
                            type: number
                  total_stats:
                    type: array
                    items:
                      type: object
                      properties:
                        stat_id:
                          type: string
                        stat_name:
                          type: string
                        value:
                          type: number
        "400":
          description: Invalid team_key or missing league_id
        "500":
          description: Internal server error

  /teams/{league_id}:
    get:
      summary: Get all teams in a league
      operationId: getTeams
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Returns all teams in the league

  /roster/{team_key}:
    get:
      summary: Get a team roster with enriched stats
      operationId: getRoster
      parameters:
        - in: path
          name: team_key
          required: true
          schema:
            type: string
          description: Yahoo team key (e.g., 461.l.1157326.t.1)
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Optional week number for week-specific stats (aggregated week totals, not per-game)
      responses:
        "200":
          description: Returns team roster with enriched player stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  team_key:
                    type: string
                  league_id:
                    type: string
                  week:
                    type: string
                    nullable: true
                  count:
                    type: integer
                  players:
                    type: array
                    items:
                      type: object
                  raw:
                    type: object
        "500":
          description: Internal server error

  /all-rosters/{league_id}:
    get:
      summary: Get simplified rosters for all teams in a league (no player stats, for performance)
      operationId: getAllRosters
      description: >
        Returns all team rosters without player stats for fast retrieval. Use /roster/{team_key}
        endpoint to get individual rosters with enriched player stats.
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
          description: Yahoo league ID (digits or full key like 461.l.1157326)
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Optional week parameter (not used when stats are disabled)
      responses:
        "200":
          description: Returns simplified rosters for all teams without player stats (use /roster/{team_key} for stats)
          content:
            application/json:
              schema:
                type: object
                properties:
                  league_id:
                    type: string
                  week:
                    type: string
                    nullable: true
                  teams:
                    type: array
                    items:
                      type: object
                      properties:
                        team_key:
                          type: string
                        team_id:
                          type: string
                        name:
                          type: string
                        manager:
                          type: string
                        players:
                          type: array
                          items:
                            type: object
        "500":
          description: Internal server error

  /available-players/{league_id}:
    get:
      summary: Get available players in a league with enriched stats
      description: >
        Returns available players with enriched stats. Any query parameters (except `week`)
        are passed through to Yahoo as filters. The `week` parameter is handled separately
        for week-specific stats. Weekly stats are aggregated totals for that week, not game-by-game breakdowns.
      operationId: getAvailablePlayers
      parameters:
        - in: path
          name: league_id
          required: true
          schema:
            type: string
          description: Yahoo league ID (digits or full key)
        - in: query
          name: week
          required: false
          schema:
            type: string
          description: Optional week number for week-specific stats (aggregated week totals, not per-game)
        - in: query
          name: status
          required: false
          schema:
            type: string
          description: Player status filter (passed to Yahoo)
        - in: query
          name: position
          required: false
          schema:
            type: string
          description: Player position filter (passed to Yahoo)
      responses:
        "200":
          description: Returns available players with enriched stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  league_id:
                    type: string
                  week:
                    type: string
                    nullable: true
                  count:
                    type: integer
                  players:
                    type: array
                    items:
                      type: object
                      properties:
                        player_key:
                          type: string
                        name:
                          type: string
                        team:
                          type: string
                        position:
                          type: string
                        stats:
                          type: array
                          items:
                            type: object
                  raw:
                    type: object
        "500":
          description: Internal server error

  /waivers:
    get:
      summary: Get available players (waivers/free agents) with enriched stats
      description: >
        Returns available players in a Yahoo Fantasy Football league with enriched stats,
        with optional filtering by position, availability status, and week.
        Weekly stats are aggregated totals for that week, not game-by-game breakdowns.
      operationId: getWaivers
      parameters:
        - name: league_id
          in: query
          required: true
          schema:
            type: string
            example: "461.l.1157326"
          description: Yahoo Fantasy league ID (digits or full key)
        - name: position
          in: query
          required: false
          schema:
            type: string
            enum: [QB, RB, WR, TE, K, DEF, ALL]
            default: ALL
          description: Filter by player position
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: [A, FA, W]
            default: A
          description: >
            Player availability filter:
            - `A`: All available players
            - `FA`: Free agents only
            - `W`: Players currently on waivers
        - name: week
          in: query
          required: false
          schema:
            type: string
          description: Optional week number for week-specific stats (aggregated week totals, not per-game)
      responses:
        "200":
          description: Successfully retrieved available players with enriched stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  league_id:
                    type: string
                  position:
                    type: string
                  status:
                    type: string
                  week:
                    type: string
                    nullable: true
                  count:
                    type: integer
                  players:
                    type: array
                    items:
                      type: object
                      properties:
                        player_key:
                          type: string
                          example: "nfl.p.30199"
                        name:
                          type: string
                          example: "Player Name"
                        team:
                          type: string
                          example: "KC"
                        position:
                          type: string
                          example: "RB"
                        status:
                          type: string
                          example: "FA"
                        stats:
                          type: array
                          items:
                            type: object
                            properties:
                              stat_id:
                                type: string
                              stat_name:
                                type: string
                              value:
                                type: [string, number, "null"]
                        stats_type:
                          type: string
                          nullable: true
                        week:
                          type: string
                          nullable: true
        "400":
          description: Missing required parameters or invalid query
        "500":
          description: Internal server error

  /player:
    get:
      summary: Get one or more players' stats (league-scoped)
      description: Returns league-scoped stats for Yahoo player keys. Weekly stats are aggregated week totals, not game-by-game breakdowns (Yahoo API limitation).
      operationId: getPlayerStats
      parameters:
        - name: league_id
          in: query
          required: true
          schema:
            type: string
          description: Yahoo league ID (digits or full key like 461.l.XXXX)
        - name: player_key
          in: query
          required: false
          schema:
            type: string
          description: Repeatable. Provide one or more player_key params (e.g., player_key=nfl.p.30199&player_key=nfl.p.12345).
        - name: player_keys
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated Yahoo player keys (e.g., nfl.p.30199,nfl.p.12345).
        - name: type
          in: query
          required: false
          schema:
            type: string
            enum: [season, week]
          description: Stats coverage type. `season` = full season totals, `week` = aggregated totals for that week (not game-by-game).
        - name: week
          in: query
          required: false
          schema:
            type: string
          description: >
            Week number. Required if `type=week`, but can also be provided standalone
            for week-specific stats (will automatically set `stats_type=week`).
            Returns aggregated totals for that week, NOT per-game breakdowns.
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PlayersStatsResponse"
        "400":
          description: Missing or invalid parameters
        "502":
          description: Upstream Yahoo error
        "500":
          description: Internal server error

components:
  schemas:
    EnrichedStat:
      type: object
      properties:
        stat_id:
          type: string
        stat_name:
          type: [string, "null"]
        value:
          type: [string, number, "null"]
    PlayerStatsPayload:
      type: object
      properties:
        league_id:
          type: string
        player_key:
          type: string
        name:
          type: [string, "null"]
        team:
          type: [string, "null"]
        positions:
          type: array
          items:
            type: string
        stats_type:
          type: [string, "null"]
          description: season or week
        week:
          type: [string, "null"]
        stats:
          type: array
          items:
            $ref: "#/components/schemas/EnrichedStat"
    PlayersStatsResponse:
      type: object
      properties:
        count:
          type: integer
          description: Number of players with stats successfully retrieved
        players:
          type: array
          items:
            $ref: "#/components/schemas/PlayerStatsPayload"
        warnings:
          type: object
          nullable: true
          description: Present if some requested players could not be fetched
          properties:
            skipped_players:
              type: array
              items:
                type: string
              description: List of player keys that were skipped
            message:
              type: string
              description: Explanation of why players were skipped
